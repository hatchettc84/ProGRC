name: Jira Ticket Check
on:
  pull_request:
    types: [opened, edited, synchronize]
    branches: [dev]

jobs:
  jira-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check for Jira ticket
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
        run: |
          # Define allowed Jira project prefixes (customize as needed)
          ALLOWED_PROJECTS="KDEV|JRA|PROJ|TASK"
          
          # Enhanced regex pattern for specific project prefixes
          JIRA_PATTERN="($ALLOWED_PROJECTS)-[0-9]+"
          
          echo "üîç Checking for Jira ticket in PR..."
          echo "PR Title: $PR_TITLE"
          echo "Branch: $BRANCH_NAME"
          
          # Check PR title for Jira ticket pattern
          if [[ "$PR_TITLE" =~ $JIRA_PATTERN ]]; then
            TICKET=$(echo "$PR_TITLE" | grep -oE "$JIRA_PATTERN" | head -1)
            echo "‚úÖ Jira ticket found in PR title: $TICKET"
          # Check PR body for Jira ticket pattern
          elif [[ "$PR_BODY" =~ $JIRA_PATTERN ]]; then
            TICKET=$(echo "$PR_BODY" | grep -oE "$JIRA_PATTERN" | head -1)
            echo "‚úÖ Jira ticket found in PR description: $TICKET"
          # Check branch name for Jira ticket pattern
          elif [[ "$BRANCH_NAME" =~ $JIRA_PATTERN ]]; then
            TICKET=$(echo "$BRANCH_NAME" | grep -oE "$JIRA_PATTERN" | head -1)
            echo "‚úÖ Jira ticket found in branch name: $TICKET"
          else
            echo "‚ùå No valid Jira ticket found!"
            echo ""
            echo "üìã Requirements:"
            echo "‚Ä¢ Include a Jira ticket number in your PR title, description, or branch name"
            echo "‚Ä¢ Accepted formats: KDEV-123, JRA-456, PROJ-789, TASK-101"
            echo "‚Ä¢ Current branch: $BRANCH_NAME"
            echo ""
            echo "üí° Examples:"
            echo "‚Ä¢ PR Title: 'KDEV-1338: Fix template service issues'"
            echo "‚Ä¢ Branch: 'feature/KDEV-1338-template-fixes'"
            echo "‚Ä¢ PR Description: 'Resolves KDEV-1338'"
            exit 1
          fi
          
          # Optional: Set output for other steps to use
          echo "jira-ticket=$TICKET" >> $GITHUB_OUTPUT

      - name: Add PR comment if check fails
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå **Jira Ticket Check Failed**
              
              This pull request is missing a valid Jira ticket reference. Please include a Jira ticket number in one of the following locations:
              
              - PR Title (recommended)
              - PR Description
              - Branch name
              
              **Accepted formats:** KDEV-123, JRA-456, PROJ-789, TASK-101
              
              **Examples:**
              - PR Title: \`KDEV-1338: Fix template service issues\`
              - Branch: \`feature/KDEV-1338-template-fixes\`
              - PR Description: \`Resolves KDEV-1338\`
              
              Please update your PR and the check will run automatically.`
            }) 