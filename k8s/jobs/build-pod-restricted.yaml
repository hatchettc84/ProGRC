apiVersion: v1
kind: Pod
metadata:
  name: backend-builder-kaniko
  namespace: progrc-dev
spec:
  restartPolicy: Never
  containers:
  - name: prepare
    image: alpine:latest
    command: ['sh', '-c']
    args:
    - |
      set -e
      cd /workspace
      echo "Extracting source code..."
      tar -xzf source.tar.gz
      echo "Source code extracted"
      ls -la
      echo "Waiting for Kaniko to build..."
      sleep 3600
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      runAsNonRoot: true
      runAsUser: 65532
      seccompProfile:
        type: RuntimeDefault
    volumeMounts:
    - name: workspace
      mountPath: /workspace
  - name: kaniko
    image: gcr.io/kaniko-project/executor:v1.24.0
    args:
    - --dockerfile=Dockerfile
    - --context=dir:///workspace
    - --destination=registry.digitalocean.com/progrc/progrc-backend:latest
    - --cache=true
    - --cache-ttl=24h
    - --compressed-caching=false
    - --verbosity=info
    - --skip-tls-verify
    - --snapshot-mode=redo
    - --use-new-run
    env:
    - name: DOCKER_CONFIG
      value: /kaniko/.docker
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      runAsNonRoot: false
      runAsUser: 0
      seccompProfile:
        type: RuntimeDefault
    volumeMounts:
    - name: workspace
      mountPath: /workspace
    - name: docker-config
      mountPath: /kaniko/.docker
  volumes:
  - name: workspace
    emptyDir: {}
  - name: docker-config
    secret:
      secretName: registry-progrc
      items:
      - key: .dockerconfigjson
        path: config.json
  securityContext:
    runAsNonRoot: false
    runAsUser: 0
    fsGroup: 0
    seccompProfile:
      type: RuntimeDefault
